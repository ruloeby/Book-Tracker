<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browse Books - Book Management System</title>
    <link rel="stylesheet" th:href="@{/css/vetrine.css}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .add-to-library-btn {
            background: #4e73df;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .add-to-library-btn:hover {
            background: #3d5fc4;
            transform: translateY(-2px);
        }
        .add-to-library-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .add-to-library-btn.added {
            background: #10b981;
        }
        .view-details-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .view-details-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
            color: white;
        }
        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .success-message, .error-message, .warning-message {
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 9999;
            display: none;
            animation: slideIn 0.3s ease;
        }
        .success-message { background: #10b981; }
        .error-message { background: #ef4444; }
        .warning-message { background: #f59e0b; }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748b;
        }
        .modal-body { padding: 10px 0; }
        .book-details-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            align-items: start;
        }
        .book-cover-large {
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .book-info-details {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .detail-label {
            font-weight: 600;
            color: #374151;
            min-width: 120px;
        }
        .detail-value {
            color: #6b7280;
            flex: 1;
        }
        .subjects-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        .subject-tag {
            background: #e5e7eb;
            color: #374151;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .btn {
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary {
            background: #4e73df;
            color: white;
        }
        .btn-primary:hover {
            background: #3d5fc4;
            color: white;
        }
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-outline-secondary {
            background: transparent;
            color: #6c757d;
            border: 2px solid #6c757d;
        }
        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
        }
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
        }
        header nav a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 5px;
            transition: background 0.3s;
        }
        header nav a:hover {
            background: rgba(255,255,255,0.2);
        }
        @media (max-width: 768px) {
            .book-details-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .detail-item {
                flex-direction: column;
                align-items: center;
                text-align: center;
                gap: 5px;
            }
            .detail-label { min-width: auto; }
        }
    </style>
</head>
<body>
<!-- Success/Error Messages -->
<div id="successMessage" class="success-message">
    <i class="fas fa-check-circle"></i> <span id="successText">Book added to your library!</span>
</div>
<div id="errorMessage" class="error-message">
    <i class="fas fa-exclamation-circle"></i> <span id="errorText">Error occurred</span>
</div>
<div id="warningMessage" class="warning-message">
    <i class="fas fa-exclamation-triangle"></i> <span id="warningText">Warning message</span>
</div>

<!-- Book Details Modal -->
<div id="bookDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Book Details</h3>
            <button class="modal-close" onclick="closeBookDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="book-details-grid">
                <div>
                    <img id="modalBookCover" src="" alt="Book Cover" class="book-cover-large">
                </div>
                <div class="book-info-details">
                    <h4 id="modalBookTitle" class="fw-bold mb-3"></h4>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-user-pen"></i> Author:</span>
                        <span id="modalBookAuthor" class="detail-value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-calendar"></i> First Published:</span>
                        <span id="modalBookYear" class="detail-value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-barcode"></i> ISBN:</span>
                        <span id="modalBookIsbn" class="detail-value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-layer-group"></i> Pages:</span>
                        <span id="modalBookPages" class="detail-value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-building"></i> Publisher:</span>
                        <span id="modalBookPublisher" class="detail-value"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-tags"></i> Subjects:</span>
                        <div class="detail-value">
                            <div id="modalBookSubjects" class="subjects-list"></div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label"><i class="fas fa-align-left"></i> Description:</span>
                        <span id="modalBookDescription" class="detail-value"></span>
                    </div>
                    <div class="mt-4">
                        <button id="modalAddButton" class="btn btn-primary" onclick="addCurrentBookToLibrary()">
                            <i class="fas fa-plus"></i> Add to My Library
                        </button>
                        <button class="btn btn-outline-secondary" onclick="closeBookDetailsModal()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<header>
    <div class="logo">
        <h1><i class="fas fa-book"></i> Book Management</h1>
    </div>
    <nav>
        <ul>
            <li th:unless="${isLoggedIn}">
                <a th:href="@{/home}"><i class="fas fa-home"></i> Home</a>
            </li>
            <li th:if="${isLoggedIn}">
                <a th:href="@{/dashboard}"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            </li>
            <li th:unless="${isLoggedIn}">
                <a th:href="@{/login}"><i class="fas fa-sign-in-alt"></i> Login</a>
            </li>
            <li th:if="${isLoggedIn}">
                <a th:href="@{/logout}"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
        </ul>
    </nav>
</header>

<main>
    <section class="vitrine">
        <h2>Browse & Discover Books</h2>
        <div class="search-container">
            <form th:action="@{/vetrine}" method="get">
                <input type="text" name="query" placeholder="Search books by title, author, or subject..."
                       th:value="${query}" required>
                <button type="submit"><i class="fas fa-search"></i> Search</button>
            </form>
        </div>

        <div th:if="${query != null}" style="margin: 20px 0;">
            <p style="color: #64748b; font-size: 14px;">
                <i class="fas fa-info-circle"></i>
                Showing results for: <strong th:text="${query}">search query</strong>
                (<span th:text="${books != null ? books.size() : 0}">0</span> results)
            </p>
        </div>

        <div class="books-container">
            <div class="book-card" th:each="book : ${books}">
                <img th:if="${book['cover_i'] != null}"
                     th:src="'https://covers.openlibrary.org/b/id/' + ${book['cover_i']} + '-M.jpg'"
                     alt="Book Cover">
                <img th:unless="${book['cover_i'] != null}"
                     th:src="@{/image/default-book.jpg}"
                     alt="Book Cover"
                     onerror="this.src='https://via.placeholder.com/200x300?text=No+Cover'">

                <div class="book-info">
                    <h3 th:text="${book.title}">Book Title</h3>
                    <p th:text="${book['author_name'] != null && !#lists.isEmpty(book['author_name']) ? book['author_name'][0] : 'Unknown Author'}">
                        Author Name
                    </p>

                    <div class="book-actions">
                        <button class="view-details-btn"
                                onclick="showBookDetails(this)"
                                th:data-title="${book.title}"
                                th:data-author="${book['author_name'] != null && !#lists.isEmpty(book['author_name']) ? book['author_name'][0] : 'Unknown Author'}"
                                th:data-cover="${book['cover_i']}"
                                th:data-year="${book['first_publish_year']}"
                                th:data-isbn="${book['isbn'] != null && !#lists.isEmpty(book['isbn']) ? book['isbn'][0] : 'Not available'}"
                                th:data-pages="${book['number_of_pages_median']}"
                                th:data-publisher="${book['publisher'] != null && !#lists.isEmpty(book['publisher']) ? book['publisher'][0] : 'Not specified'}"
                                th:data-subjects="${book['subject'] != null ? #strings.listJoin(book['subject'], '||') : ''}"
                                th:data-description="${book['first_sentence'] != null && !#lists.isEmpty(book['first_sentence']) ? book['first_sentence'][0] : 'No description available'}">
                            <i class="fas fa-info-circle"></i> View Details
                        </button>

                        <button class="add-to-library-btn"
                                th:if="${isLoggedIn}"
                                onclick="addToLibrary(this)"
                                th:data-title="${book.title}"
                                th:data-author="${book['author_name'] != null && !#lists.isEmpty(book['author_name']) ? book['author_name'][0] : 'Unknown Author'}"
                                th:data-cover="${book['cover_i']}"
                                th:data-pages="${book['number_of_pages_median']}">
                            <i class="fas fa-plus"></i> Add to Library
                        </button>

                        <a th:unless="${isLoggedIn}"
                           th:href="@{/login}"
                           class="add-to-library-btn"
                           style="text-decoration: none;">
                            <i class="fas fa-sign-in-alt"></i> Login to Add
                        </a>
                    </div>
                </div>
            </div>

            <div th:if="${books == null or books.isEmpty()}"
                 style="text-align: center; padding: 60px 20px; color: #64748b;">
                <i class="fas fa-search" style="font-size: 64px; margin-bottom: 20px; color: #cbd5e1;"></i>
                <h3>No books found</h3>
                <p th:if="${query != null}">Try searching with different keywords</p>
                <p th:unless="${query != null}">Use the search box above to find books</p>
            </div>
        </div>
    </section>
</main>

<footer>
    <p>&copy; 2025 Book Management System. All rights reserved.</p>
</footer>

<script th:inline="javascript">
    let currentBookData = null;
    let userLibraryBooks = new Set();
    const isLoggedIn = /*[[${isLoggedIn}]]*/ false;

    document.addEventListener('DOMContentLoaded', function() {
        if (isLoggedIn) {
            loadUserLibrary();
        }
    });

    async function loadUserLibrary() {
        try {
            const response = await fetch('/api/library/titles');
            if (response.ok) {
                const titles = await response.json();
                titles.forEach(title => userLibraryBooks.add(title.toLowerCase().trim()));
            }
        } catch (error) {
            console.log('Could not load library:', error);
        }
    }

    function showBookDetails(button) {
        const data = button.dataset;
        currentBookData = {
            title: data.title,
            author: data.author,
            coverUrl: data.cover ? `https://covers.openlibrary.org/b/id/${data.cover}-M.jpg` : null,
            totalPages: data.pages ? parseInt(data.pages) : 0,
            status: 'TO_READ'
        };

        document.getElementById('modalBookTitle').textContent = data.title;
        document.getElementById('modalBookAuthor').textContent = data.author;
        document.getElementById('modalBookYear').textContent = data.year || 'Unknown';
        document.getElementById('modalBookIsbn').textContent = data.isbn || 'N/A';
        document.getElementById('modalBookPages').textContent = data.pages ? `${data.pages} pages` : 'Unknown';
        document.getElementById('modalBookPublisher').textContent = data.publisher || 'N/A';
        document.getElementById('modalBookDescription').textContent = data.description || 'No description';

        const subjectsContainer = document.getElementById('modalBookSubjects');
        subjectsContainer.innerHTML = '';
        if (data.subjects) {
            const subjectArray = data.subjects.split('||');
            subjectArray.slice(0, 5).forEach(subject => {
                const tag = document.createElement('span');
                tag.className = 'subject-tag';
                tag.textContent = subject.trim();
                subjectsContainer.appendChild(tag);
            });
            if (subjectArray.length > 5) {
                const moreTag = document.createElement('span');
                moreTag.className = 'subject-tag';
                moreTag.textContent = `+${subjectArray.length - 5} more`;
                subjectsContainer.appendChild(moreTag);
            }
        } else {
            subjectsContainer.innerHTML = '<span class="text-muted">No subjects available</span>';
        }

        const coverImg = document.getElementById('modalBookCover');
        coverImg.src = data.cover
            ? `https://covers.openlibrary.org/b/id/${data.cover}-M.jpg`
            : 'https://via.placeholder.com/200x300?text=No+Cover';

        const addButton = document.getElementById('modalAddButton');
        if (!isLoggedIn) {
            addButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login to Add';
            addButton.onclick = function() { window.location.href = '/login'; };
        } else if (userLibraryBooks.has(data.title.toLowerCase().trim())) {
            addButton.innerHTML = '<i class="fas fa-check"></i> Already in Library';
            addButton.disabled = true;
            addButton.style.background = '#10b981';
        } else {
            addButton.innerHTML = '<i class="fas fa-plus"></i> Add to My Library';
            addButton.disabled = false;
            addButton.style.background = '';
            addButton.onclick = addCurrentBookToLibrary;
        }

        document.getElementById('bookDetailsModal').classList.add('show');
    }

    function closeBookDetailsModal() {
        document.getElementById('bookDetailsModal').classList.remove('show');
        currentBookData = null;
    }

    function addCurrentBookToLibrary() {
        if (!currentBookData) {
            showMessage('error', 'No book selected');
            return;
        }

        if (!isLoggedIn) {
            window.location.href = '/login';
            return;
        }

        if (userLibraryBooks.has(currentBookData.title.toLowerCase().trim())) {
            showMessage('warning', 'This book is already in your library!');
            return;
        }

        const addButton = document.getElementById('modalAddButton');
        const originalText = addButton.innerHTML;

        addButton.disabled = true;
        addButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

        fetch('/dashboard/add-book', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(currentBookData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('success', 'Book added to your library!');
                    addButton.innerHTML = '<i class="fas fa-check"></i> Added to Library';
                    addButton.style.background = '#10b981';
                    userLibraryBooks.add(currentBookData.title.toLowerCase().trim());
                    setTimeout(closeBookDetailsModal, 1500);
                } else {
                    showMessage('error', data.message || 'Failed to add book');
                    addButton.disabled = false;
                    addButton.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'An error occurred while adding the book');
                addButton.disabled = false;
                addButton.innerHTML = originalText;
            });
    }

    function addToLibrary(button) {
        if (!isLoggedIn) {
            window.location.href = '/login';
            return;
        }

        const data = button.dataset;
        const title = data.title;

        if (userLibraryBooks.has(title.toLowerCase().trim())) {
            showMessage('warning', 'This book is already in your library!');
            button.innerHTML = '<i class="fas fa-check"></i> Already Added';
            button.classList.add('added');
            return;
        }

        const bookData = {
            title: title,
            author: data.author,
            coverUrl: data.cover ? `https://covers.openlibrary.org/b/id/${data.cover}-M.jpg` : null,
            totalPages: data.pages ? parseInt(data.pages) : 0,
            status: 'TO_READ'
        };

        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

        fetch('/dashboard/add-book', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(bookData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('success', 'Book added to your library!');
                    button.innerHTML = '<i class="fas fa-check"></i> Added';
                    button.style.background = '#10b981';
                    userLibraryBooks.add(title.toLowerCase().trim());
                } else {
                    showMessage('error', data.message || 'Failed to add book');
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-plus"></i> Add to Library';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('error', 'An error occurred while adding the book');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-plus"></i> Add to Library';
            });
    }

    function showMessage(type, message) {
        const element = document.getElementById(type + 'Message');
        element.querySelector('span').textContent = message;
        element.style.display = 'block';
        setTimeout(() => element.style.display = 'none', 3000);
    }

    document.getElementById('bookDetailsModal').addEventListener('click', function(e) {
        if (e.target === this) closeBookDetailsModal();
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeBookDetailsModal();
    });
</script>
</body>
</html>